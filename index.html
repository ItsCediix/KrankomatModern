<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Krankomat Modern</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' https://unpkg.com https://cdn.tailwindcss.com;">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
      body {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        background-color: #f8fafc; /* bg-slate-50 */
        font-family: 'Inter', sans-serif; /* A more modern font, falls back to sans-serif */
      }
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    </style>
    <!-- React and ReactDOM from CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel Standalone for JSX/TSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<link rel="stylesheet" href="/index.css">
</head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>

    <script type="text/babel">
      // All application code is consolidated into this single script block.
      // The browser will transpile and run it on the fly thanks to Babel.
      const { useState, useEffect, useMemo, useCallback } = React;

      // --- UTILS ---
      const todayFormatted = () => {
        const today = new Date();
        const day = String(today.getDate()).padStart(2, '0');
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const year = today.getFullYear();
        return `${day}.${month}.${year}`;
      };

      const getDayOfWeek = (dateStr) => {
        const parts = dateStr.match(/(\d{2})\.(\d{2})\.(\d{4})/);
        if (!parts) return null;
        const date = new Date(`${parts[3]}-${parts[2]}-${parts[1]}`);
        if (isNaN(date.getTime())) return null;
        const days = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
        return days[date.getDay()];
      };

      const renderTemplate = (template, context) => {
        return Object.entries(context).reduce((acc, [key, value]) => {
            return acc.replace(new RegExp(`{${key}}`, 'g'), value || '');
        }, template);
      };

      const copyToClipboard = (text, onComplete) => {
        navigator.clipboard.writeText(text).then(() => {
          if (onComplete) onComplete();
        }).catch(err => {
          console.error('Failed to copy text: ', err);
        });
      };

      // --- CONSTANTS ---
      const DEFAULT_USER_DATA = {
        firstName: 'Max',
        lastName: 'Mustermann',
        studentId: '1234567',
        email: 'max.mustermann@example.com',
        studyProgram: 'EGOV',
      };

      const RECIPIENTS_DATA_STRUCTURE = [
        { id: 1, anrede: 'Sehr geehrte Damen und Herren vom ZPD', module: 'ZPD / Ausbildungsleitung', isSelected: true },
        { id: 2, anrede: 'Sehr geehrte Frau Prof. Dr. Schmidt', module: 'IT-Projektmanagement', isSelected: false },
        { id: 3, anrede: 'Sehr geehrter Herr Dr. Meier', module: 'Grundlagen der BWL', isSelected: false },
        { id: 4, anrede: 'Sehr geehrte Damen und Herren', module: 'Berufspraxisstelle', isSelected: false },
        { id: 5, anrede: 'Sehr geehrte Frau Müller', module: 'Datenbanken', isSelected: false },
        { id: 6, anrede: 'Sehr geehrter Herr Weber', module: 'Software Engineering', isSelected: false },
        { id: 7, anrede: 'Sehr geehrtes Prüfungsamt-Team', module: 'HAW-Prüfungsamt', isSelected: false }
      ];

      const TIMETABLE_DATA = [
          { day: 'Montag', module: 'IT-Projektmanagement' },
          { day: 'Dienstag', module: 'Grundlagen der BWL' },
          { day: 'Mittwoch', module: 'Datenbanken' },
          { day: 'Donnerstag', module: 'Software Engineering' },
          { day: 'Freitag', module: 'IT-Projektmanagement' },
      ];

      const EMAIL_SUBJECT_TEMPLATE = "{art} EGOV 2025 {Datum} [{Vornamen} {Nachname}, {Matrikelnummer}]";
      
      // --- COMPONENTS ---
      const Header = () => (
        <header className="bg-white shadow-sm">
          <div className="container mx-auto px-4 lg:px-8 py-5">
            <div className="flex items-center space-x-3">
              <i className="fa-solid fa-file-medical text-3xl text-indigo-600"></i>
              <div>
                <h1 className="text-3xl font-bold text-slate-800">
                  Krankomat <span className="text-indigo-600">Modern</span>
                </h1>
                <p className="text-slate-500 mt-1">

Das Krankomat-Entwicklerteam:

Fabian Flocken, 
Laurin Bennet Jaetschmann, 
Marvin Junk und
Cederic Langpaap
</p>
              </div>
            </div>
          </div>
        </header>
      );

      const Card = ({ title, children, className }) => (
        <div className={`bg-white rounded-xl shadow-lg ${className}`}>
          <div className="p-6">
            <h2 className="text-xl font-bold text-slate-800 border-b border-slate-200 pb-4 mb-5">
              {title}
            </h2>
            <div className="space-y-5">
              {children}
            </div>
          </div>
        </div>
      );

      const FormField = ({ label, id, type = 'text', value, onChange, placeholder, className }) => (
        <div className={`flex flex-col ${className}`}>
          <label htmlFor={id} className="mb-1.5 text-sm font-medium text-slate-600">{label}</label>
          <input
            id={id}
            type={type}
            value={value}
            onChange={onChange}
            placeholder={placeholder}
            className="px-4 py-2.5 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200"
          />
        </div>
      );
      
      const Checkbox = ({ label, checked, onChange, id }) => (
        <label htmlFor={id} className="flex items-center space-x-3 cursor-pointer group">
          <div className="relative flex items-center">
            <input
              id={id}
              type="checkbox"
              checked={checked}
              onChange={onChange}
              className="peer relative h-5 w-5 cursor-pointer appearance-none rounded-md border border-slate-400 transition-all checked:border-indigo-600 checked:bg-indigo-600"
            />
            <div className="pointer-events-none absolute top-2/4 left-2/4 -translate-y-2/4 -translate-x-2/4 text-white opacity-0 transition-opacity peer-checked:opacity-100">
                <svg xmlns="http://www.w3.org/2000/svg" className="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor" stroke="currentColor" strokeWidth="1">
                    <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd"></path>
                </svg>
            </div>
          </div>
          <span className="text-sm text-slate-700 group-hover:text-indigo-600 transition-colors">
            {label}
          </span>
        </label>
      );

      const UserInfoPanel = ({ userData, setUserData, sicknessStartDate, setSicknessStartDate, sicknessEndDate, setSicknessEndDate, onManualSave, saveStatus }) => {
        const handleUserChange = (field, value) => setUserData(prev => ({ ...prev, [field]: value }));
        const noticeType = sicknessEndDate ? 'Gesundmeldung' : 'Krankmeldung';

        const handleNoticeTypeChange = (type) => {
          if (type === 'Krankmeldung') setSicknessEndDate('');
          else if (type === 'Gesundmeldung' && !sicknessEndDate) setSicknessEndDate(todayFormatted());
        };

        return (
          <Card title="Allgemeine Informationen">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <FormField label="Vorname" id="firstName" value={userData.firstName} onChange={(e) => handleUserChange('firstName', e.target.value)} />
              <FormField label="Nachname" id="lastName" value={userData.lastName} onChange={(e) => handleUserChange('lastName', e.target.value)} />
              <FormField label="Matrikelnummer" id="studentId" value={userData.studentId} onChange={(e) => handleUserChange('studentId', e.target.value)} />
              <FormField label="Absender-E-Mail" id="email" type="email" value={userData.email} onChange={(e) => handleUserChange('email', e.target.value)} />
            </div>
            <div className="border-t border-slate-200 mt-4 pt-4 space-y-4">
              <div className="p-1 flex bg-slate-100 rounded-full">
                <button onClick={() => handleNoticeTypeChange('Krankmeldung')} className={`w-1/2 py-2 text-sm font-semibold rounded-full transition-all duration-300 ${noticeType === 'Krankmeldung' ? 'bg-white text-indigo-600 shadow' : 'text-slate-600 hover:bg-slate-200'}`}>Krankmeldung</button>
                <button onClick={() => handleNoticeTypeChange('Gesundmeldung')} className={`w-1/2 py-2 text-sm font-semibold rounded-full transition-all duration-300 ${noticeType === 'Gesundmeldung' ? 'bg-white text-green-600 shadow' : 'text-slate-600 hover:bg-slate-200'}`}>Gesundmeldung</button>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                <FormField label="Erster Krankheitstag" id="startDate" value={sicknessStartDate} onChange={e => setSicknessStartDate(e.target.value)} />
                <div className="flex flex-col">
                    <FormField label="Letzter Krankheitstag (optional)" id="endDate" value={sicknessEndDate} onChange={e => setSicknessEndDate(e.target.value)} />
                    <button onClick={() => setSicknessEndDate(todayFormatted())} className="mt-2 text-sm text-indigo-600 hover:text-indigo-800 self-start font-medium">heute wieder gesund</button>
                </div>
              </div>
            </div>
            <div className="flex justify-end pt-4 mt-2">
              <button
                onClick={onManualSave}
                className={`inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 ${
                  saveStatus === 'saved'
                    ? 'bg-green-500 text-white cursor-default'
                    : 'text-indigo-700 bg-indigo-100 hover:bg-indigo-200'
                }`}
                disabled={saveStatus === 'saved'}
                aria-live="polite"
              >
                {saveStatus === 'saved' ? (
                  <>
                    <i className="fa-solid fa-check mr-2"></i>
                    Gespeichert!
                  </>
                ) : (
                  <>
                    <i className="fa-solid fa-floppy-disk mr-2"></i>
                    Speichern
                  </>
                )}
              </button>
            </div>
          </Card>
        );
      };

      const AbsencePanel = ({ reasons, onToggle }) => (
        <Card title="Heute verpasse ich...">
          <Checkbox id="lecture" label="Vorlesungszeit" checked={reasons.lecture} onChange={() => onToggle('lecture')} />
          <Checkbox id="internship" label="Berufspraxis" checked={reasons.internship} onChange={() => onToggle('internship')} />
          <Checkbox id="exam" label="Prüfungsleistung / Klausur" checked={reasons.exam} onChange={() => onToggle('exam')} />
          <Checkbox id="partialDay" label="Rest des Tages (war schon da)" checked={reasons.partialDay} onChange={() => onToggle('partialDay')} />
        </Card>
      );
      
      const DetailsPanel = ({ details, onChange }) => {
        const commentPresets = ["nur 1 Tag krank", "vsl. ungefähr 3 Tage krank", "vsl. länger als 3 Tage, Arzt wird aufgesucht"];
        const handleCommentPresetToggle = (text) => {
          const currentComments = details.comments.split('\n').filter(line => line.trim() !== '');
          const newComments = currentComments.includes(text) ? currentComments.filter(c => c !== text) : [...currentComments, text];
          onChange('comments', newComments.join('\n'));
        };
          
        return (
          <Card title="Details & Optionen">
            <div className="grid grid-cols-2 gap-4">
              <Checkbox id="accident" label="Unfall" checked={details.isAccident} onChange={() => onChange('isAccident', !details.isAccident)} />
              <Checkbox id="gkv" label="GKV" checked={details.isGKV} onChange={() => onChange('isGKV', !details.isGKV)} />
              <Checkbox id="attest" label="Attest" checked={details.hasAttest} onChange={() => onChange('hasAttest', !details.hasAttest)} />
              <Checkbox id="eau" label="eAU" checked={details.hasEAU} onChange={() => onChange('hasEAU', !details.hasEAU)} />
            </div>
            <div className="pt-4">
              <label htmlFor="comments" className="mb-1.5 text-sm font-medium text-slate-600">Bemerkung / voraussichtliche Dauer</label>
              <textarea id="comments" value={details.comments} onChange={(e) => onChange('comments', e.target.value)} rows={3} className="w-full px-4 py-2.5 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200" />
              <div className="mt-2 space-y-2">
                {commentPresets.map(preset => (<Checkbox key={preset} id={`preset-${preset}`} label={preset} checked={details.comments.includes(preset)} onChange={() => handleCommentPresetToggle(preset)} />))}
              </div>
            </div>
          </Card>
        );
      };
      
      const RecipientsPanel = ({ recipients, onToggle, onEmailChange }) => (
        <Card title="Krankmelden bei">
          <div className="max-h-80 overflow-y-auto pr-2 -mr-2 space-y-4">
            {recipients.map(recipient => (
              <div key={recipient.id} className="p-3 rounded-lg hover:bg-slate-50 transition-colors">
                <Checkbox id={`recipient-${recipient.id}`} checked={recipient.isSelected} onChange={() => onToggle(recipient.id)} label={recipient.module} />
                <input type="email" value={recipient.email || ''} onChange={(e) => onEmailChange(recipient.id, e.target.value)} placeholder="E-Mail-Adresse eingeben" className="ml-8 mt-2 w-[calc(100%-2rem)] px-3 py-1.5 border border-slate-300 rounded-md shadow-sm text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" aria-label={`Email for ${recipient.module}`} />
              </div>
            ))}
          </div>
          <div className="mt-4 p-4 bg-indigo-50 border border-indigo-200 rounded-lg text-sm text-indigo-800 flex items-start space-x-3">
            <i className="fa-solid fa-shield-halved text-indigo-500 mt-1"></i>
            <p><strong className="font-semibold">Datenschutzhinweis:</strong> Ihre Daten werden nur lokal in Ihrem Browser gespeichert und niemals an einen Server gesendet.</p>
          </div>
        </Card>
      );
      
      const CopyableField = ({ label, value }) => {
        const [copied, setCopied] = useState(false);
        const handleCopy = useCallback(() => {
          if (!value) return;
          copyToClipboard(value, () => {
            setCopied(true);
            setTimeout(() => setCopied(false), 2000);
          });
        }, [value]);

        return (
          <div>
            <label className="text-sm font-semibold text-slate-600">{label}</label>
            <div className="mt-1 relative group">
              <div className="p-3 pr-10 bg-slate-100 rounded-lg text-sm text-slate-800 whitespace-pre-wrap break-words font-mono border border-slate-200">
                {value || <span className="text-slate-400 font-sans italic">Wird automatisch generiert...</span>}
              </div>
              {value && (
                <button onClick={handleCopy} title="In die Zwischenablage kopieren" className="absolute top-2 right-2 p-2 rounded-md bg-white/50 text-slate-500 hover:bg-white hover:text-indigo-600 transition-all opacity-0 group-hover:opacity-100 focus:opacity-100" aria-label="Copy">
                  <i className={`fa-solid ${copied ? 'fa-check text-green-500' : 'fa-copy'}`}></i>
                </button>
              )}
            </div>
          </div>
        );
      };

      const AndroidIcon = () => (
        <svg className="h-5 w-5 mr-2" viewBox="83 288 265 122" xmlns="http://www.w3.org/2000/svg">
            <path 
                fill="#32de84"
                d="m 263.837 306.59 l 21.9331 -37.9944 c 1.2377 -2.12998 0.48933 -4.83565 -1.61189 -6.07335 c -2.1012 -1.23768 -4.83565 -0.5181 -6.04456 1.61189 l -22.221 38.4837 c -16.9536 -7.74281 -36.0371 -12.0604 -56.5599 -12.0604 c -20.5227 0 -39.6063 4.31754 -56.5599 12.0604 l -22.221 -38.4837 c -1.2377 -2.12999 -3.94336 -2.84957 -6.07335 -1.61189 c -2.13 1.2377 -2.84959 3.94337 -1.61189 6.07335 l 21.9331 37.9944 c -37.8217 20.494 -63.4392 58.7762 -67.6703 103.592 h 264.407 c -4.2312 -44.8161 -29.8487 -83.0984 -67.6991 -103.592 Z m -125.209 66.4614 c -6.13092 0 -11.0817 -4.97957 -11.0817 -11.0817 c 0 -6.13093 4.97957 -11.0817 11.0817 -11.0817 c 6.13092 0 11.0817 4.97956 11.0817 11.0817 c 0.0289 6.10212 -4.95079 11.0817 -11.0817 11.0817 Z m 121.381 0 c -6.13091 0 -11.0817 -4.97957 -11.0817 -11.0817 c 0 -6.13093 4.97958 -11.0817 11.0817 -11.0817 c 6.13093 0 11.0817 4.97956 11.0817 11.0817 c 0.0288 6.10212 -4.95077 11.0817 -11.0817 11.0817 Z"
            />
        </svg>
      );

      const PreviewPanel = ({ email }) => {
        const handleOpenOutlook = () => {
          if (email && email.outlookHref) {
            window.open(email.outlookHref, '_blank', 'noopener,noreferrer');
          }
        };

        return (
          <div className="bg-white rounded-xl shadow-lg sticky top-8">
            <div className="p-6">
              <h2 className="text-xl font-bold text-slate-800 border-b border-slate-200 pb-4 mb-5">Vorschau & E-Mail</h2>
              <div className="space-y-4">
                <CopyableField label="Betreff" value={email.subject} />
                <CopyableField label="An (To)" value={email.to} />
                <div>
                  <label className="text-sm font-semibold text-slate-600">Nachricht</label>
                  <div className="mt-1 relative group">
                    <div className="p-3 bg-slate-100 rounded-lg text-sm text-slate-800 whitespace-pre-wrap break-words h-64 overflow-y-auto border border-slate-200 font-mono">
                      {email.body}
                    </div>
                    <button onClick={() => copyToClipboard(email.body, () => {})} title="Nachricht kopieren" className="absolute top-2 right-2 p-2 rounded-md bg-white/50 text-slate-500 hover:bg-white hover:text-indigo-600 transition-all opacity-0 group-hover:opacity-100 focus:opacity-100" aria-label="Copy message">
                      <i className="fa-solid fa-copy"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div className="bg-slate-50 p-4 border-t border-slate-200 rounded-b-xl">
              <button 
                onClick={handleOpenOutlook} 
                disabled={!email.outlookHref}
                className="w-full inline-flex items-center justify-center px-4 py-3 border border-transparent text-base font-medium rounded-lg shadow-lg text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform hover:scale-[1.02] active:scale-[0.98] disabled:bg-indigo-400 disabled:cursor-not-allowed">
                <i className="fa-solid fa-paper-plane h-5 w-5 mr-3"></i>
                E-Mail in Outlook öffnen
              </button>
              <a
                href={email.mailtoHref || undefined}
                onClick={(e) => { if (!email.mailtoHref) e.preventDefault(); }}
                target="_blank"
                rel="noopener noreferrer"
                aria-disabled={!email.mailtoHref}
                className={`mt-3 w-full inline-flex items-center justify-center px-4 py-2 border border-slate-300 text-sm font-medium rounded-md shadow-sm text-slate-700 bg-white transition-colors ${
                  email.mailtoHref
                    ? 'hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500'
                    : 'opacity-50 cursor-not-allowed'
                }`}
              >
                <AndroidIcon />
                Öffnen mit Mail-App
              </a>
            </div>
          </div>
        );
      };

      // --- APP ---
      function App() {
        const [userData, setUserData] = useState(DEFAULT_USER_DATA);
        const [sicknessStartDate, setSicknessStartDate] = useState(todayFormatted());
        const [sicknessEndDate, setSicknessEndDate] = useState('');
        const [absenceReasons, setAbsenceReasons] = useState({ lecture: true, internship: false, exam: false, partialDay: false });
        const [recipients, setRecipients] = useState([]);
        const [details, setDetails] = useState({ isAccident: false, isGKV: false, hasAttest: false, hasEAU: false, comments: '' });
        const [saveStatus, setSaveStatus] = useState('idle');
        
        useEffect(() => {
          try {
            const savedUserData = localStorage.getItem('krankomat_userData');
            if (savedUserData) setUserData(JSON.parse(savedUserData));
            const savedRecipients = localStorage.getItem('krankomat_recipients');
            const baseRecipients = RECIPIENTS_DATA_STRUCTURE.map(r => ({ ...r, email: '' }));
            if (savedRecipients) {
              const parsed = JSON.parse(savedRecipients);
              const merged = baseRecipients.map(base => ({ ...base, ...parsed.find(sr => sr.id === base.id) }));
              setRecipients(merged);
            } else {
              setRecipients(baseRecipients);
            }
          } catch (error) {
            console.error("Failed to load data from localStorage", error);
            setRecipients(RECIPIENTS_DATA_STRUCTURE.map(r => ({ ...r, email: '' })));
          }
        }, []);

        useEffect(() => { localStorage.setItem('krankomat_userData', JSON.stringify(userData)); }, [userData]);
        useEffect(() => { if (recipients.length > 0) localStorage.setItem('krankomat_recipients', JSON.stringify(recipients)); }, [recipients]);

        const noticeType = sicknessEndDate ? 'Gesundmeldung' : 'Krankmeldung';

        useEffect(() => {
          const day = getDayOfWeek(sicknessStartDate);
          if (!day || recipients.length === 0) return;
          const todaysModules = TIMETABLE_DATA.filter(e => e.day.toLowerCase() === day.toLowerCase()).map(e => e.module.toLowerCase());
          setRecipients(prev => prev.map(r => ({ ...r, isSelected: r.module.includes('ZPD') || todaysModules.some(mod => r.module.toLowerCase().includes(mod)) })));
        }, [sicknessStartDate]);
        
        const handleRecipientToggle = (id) => setRecipients(recipients.map(r => r.id === id ? { ...r, isSelected: !r.isSelected } : r));
        const handleRecipientEmailChange = (id, email) => setRecipients(recipients.map(r => r.id === id ? { ...r, email } : r));
        const handleAbsenceReasonToggle = (reason) => setAbsenceReasons(prev => ({...prev, [reason]: !prev[reason]}));
        const handleDetailsChange = (key, value) => setDetails(prev => ({...prev, [key]: value}));
        
        const handleManualSave = useCallback(() => {
          try {
            localStorage.setItem('krankomat_userData', JSON.stringify(userData));
            localStorage.setItem('krankomat_recipients', JSON.stringify(recipients));
            setSaveStatus('saved');
            setTimeout(() => setSaveStatus('idle'), 2000);
          } catch (error) {
            console.error("Manual save to localStorage failed", error);
          }
        }, [userData, recipients]);

        const generatedEmail = useMemo(() => {
          const selectedRecipients = recipients.filter(r => r.isSelected);
          const anreden = [...new Set(selectedRecipients.map(r => r.anrede.trim()))];
          const anredeText = selectedRecipients.length === 0 ? 'Sehr geehrte Damen und Herren,' : `${anreden.join(',\n')},`;
          
          const bodyTemplate = noticeType === 'Gesundmeldung' ? 
`{anrede}

hiermit melde ich mich ab dem {Datum2} wieder gesund.
Ich war vom {Datum} bis einschließlich {Datum2} krank.

Name: {Vornamen} {Nachname}
Matrikelnummer: {Matrikelnummer}
Studiengang: {studiengang}

{bemerkung}

Mit freundlichen Grüßen
{Vornamen} {Nachname}` : 
`{anrede}

hiermit melde ich mich für den {Datum} krank.
{dauermeldung}

Name: {Vornamen} {Nachname}
Matrikelnummer: {Matrikelnummer}
Studiengang: {studiengang}

{bemerkung}

Mit freundlichen Grüßen
{Vornamen} {Nachname}`;

          const context = {
            Vornamen: userData.firstName, Nachname: userData.lastName, Matrikelnummer: userData.studentId,
            Datum: sicknessStartDate, Datum2: sicknessEndDate, art: noticeType, studiengang: userData.studyProgram,
            anrede: anredeText, bemerkung: details.comments, unfall: details.isAccident ? 'ja' : 'nein',
            attest: details.hasAttest ? 'ja' : 'nein', eAU: details.hasEAU ? 'ja' : 'nein',
            prüfungstag: absenceReasons.exam ? 'ja' : 'nein',
            dauermeldung: sicknessEndDate ? `Ich bin voraussichtlich bis einschließlich ${sicknessEndDate} krank.` : '',
          };
          
          const body = renderTemplate(bodyTemplate.trim(), context).trim();
          const subject = renderTemplate(EMAIL_SUBJECT_TEMPLATE, context);
          const toList = selectedRecipients.map(r => r.email).filter(Boolean).filter(e => e.trim() !== '');
          
          // For Outlook Web link & display - uses semicolon separation
          const toValue = toList.join('; ');
          const outlookHref = toList.length > 0 ? `https://outlook.office.com/mail/deeplink/compose?to=${encodeURIComponent(toValue)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}` : null;

          // For standard mailto link (Android) - uses comma separation
          const toMailtoValue = toList.join(',');
          const mailtoHref = toList.length > 0 ? `mailto:${toMailtoValue}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}` : null;

          return { subject, body, to: toValue, outlookHref, mailtoHref };
        }, [userData, noticeType, sicknessStartDate, sicknessEndDate, absenceReasons, recipients, details]);

        return (
          <div className="bg-slate-100 min-h-screen text-slate-800 font-sans">
            <Header />
            <main className="container mx-auto p-4 lg:p-8">
              <div className="grid grid-cols-1 lg:grid-cols-5 gap-8 items-start">
                <div className="lg:col-span-3 space-y-8">
                  <UserInfoPanel 
                    userData={userData} 
                    setUserData={setUserData} 
                    sicknessStartDate={sicknessStartDate} 
                    setSicknessStartDate={setSicknessStartDate} 
                    sicknessEndDate={sicknessEndDate} 
                    setSicknessEndDate={setSicknessEndDate}
                    onManualSave={handleManualSave}
                    saveStatus={saveStatus} 
                  />
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <AbsencePanel reasons={absenceReasons} onToggle={handleAbsenceReasonToggle} />
                    <DetailsPanel details={details} onChange={handleDetailsChange} />
                  </div>
                  <RecipientsPanel recipients={recipients} onToggle={handleRecipientToggle} onEmailChange={handleRecipientEmailChange} />
                </div>
                <div className="lg:col-span-2">
                  <PreviewPanel email={generatedEmail} />
                </div>
              </div>
            </main>
          </div>
        );
      }

      // --- RENDER ---
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<React.StrictMode><App /></React.StrictMode>);
    </script>
  <script type="module" src="/index.tsx"></script>
</body>
</html>